## Run  

### 개념  

- **코드 한 번의 실행, 즉 한 번의 프로세스**를 의미한다.  
- MLflow 에서 중심이 되는, 그리고 가장 기본의 단위.  
- 예를 들어, 학습 코드 실행 한 번, 평가 코드 실행 한 번... 등을 의미한다.  

### Run 클래스  

#### Run 클래스  

```python
# mlflow.entities.run
class Run(_MlflowObject): # _MlflowObject 상속받음
    def __init__(self ...):
        self.run_info: RunInfo,
        self.run_data: RunData,
        self.run_inputs: RunInputs | None = None,
        self.run_outputs: RunOutputs | None = None,
    ...
    @classmethod
    def from_proto(cls, proto):
        # Protocol Buffer 형식에서 객체를 생성
    ...
    def to_proto(self):
        # 객체를 다시 Protocol Buffer 형식으로 직렬화하는 역할
```

|속성|설명|
|---|---|
|run_info|run 에 대한 메타데이터. `run_id`, `start_time`, `status` 등|
|run_data|run 관련 데이터. `metric` 이나 `파라미터`, `태그` 등|
|run_inputs|dataset input을 포함한 인풋들|
|run_outputs|model output을 포함한 아웃풋들|

> 리뷰  
> Run 또한 데이터 전송 객체 (DTO) 의 형태가 보인다. : `from_proto` - `to_proto`  
> 어떤 동작을 하기보다는 단순히 "추상화된 개념"을 나타내기 위한 클래스로 보임  

#### RunInfo  

```python
# mlflow.entities.run_info
class RunInfo(_MlflowObject):
    """
    Metadata about a run.
    """
    def __init__(...):
        self._run_id
        self._experiment_id     # 필수. 없으면 에러 발생
        self._user_id           # 필수. 없으면 에러 발생
        self._status            # 필수. 없으면 에러 발생
        self._start_time        # 필수. 없으면 에러 발생
        self._end_time
        self._lifecycle_stage
        self._artifact_uri
        self._run_name
```

| 속성 | 설명 |
| --- | --- |
| _run_id | 해당 실행(Run)의 고유 식별자(ID) |
| _experiment_id | 이 실행이 속한 실험(Experiment)의 고유 식별자 |
| _user_id | 이 실행을 initiate 한 사용자의 ID |
| _status | 실행의 현재 상태를 나타냄. mlflow.entities.RunStatus 중 하나<br>RUNNING, SCHEDULED, FINISHED, FAILED, KILLED|
| _start_time | 실행이 시작된 시점의 타임스탬프 (밀리초 단위) |
| _end_time | 실행이 종료된 시점의 타임스탬프 (밀리초 단위) <br>실행 중에는 비어있거나 0일 수 있음 |
| _lifecycle_stage | 실행의 현재 수명 주기 단계를 나타냄<br>'active', 'deleted'|
| _artifact_uri | 이 실행의 아티팩트가 저장된 루트 URI |
| _run_name | 해당 실행을 식별하는 사용자 지정 이름 |

#### RunData  

```python
# mlflow.entities.run_data
class RunData(_MlflowObject):
    """
    Run data (metrics and parameters).
    """
    def __init__(self, metrics=None, params=None, tags=None):
        self._metric_objs = metrics or []
        self._metrics = {metric.key: metric.value for metric in self._metric_objs}
        self._params = {param.key: param.value for param in (params or [])}
        self._tags = {tag.key: tag.value for tag in (tags or [])}
```

|속성|설명|
|---|---|
|_metric_objs|이 Run 동안 기록된 모든 메트릭(Metric) 객체의 리스트<br>mlflow.entities.Metric 클래스의 인스턴스|
|_metrics|Run 동안 기록된 가장 최근의 메트릭 값을 담고 있는 딕셔너리<br>키(Key)는 메트릭 이름(예: 'accuracy', 'loss')이며, 값(Value)은 해당 메트릭의 최종 값|
|_params|이 Run에 사용된 매개변수(Parameter)를 담고 있는 딕셔너리<br>키(Key)는 매개변수 이름(예: 'learning_rate')이며, 값(Value)은 해당 매개변수의 문자열 값|
|_tags|이 Run에 연결된 태그(Tag)를 담고 있는 딕셔너리|

#### RunInputs  

```python
# mlflow.entities.run_inputs
class RunInputs(_MlflowObject):
    """RunInputs object."""
    def __init__(
        self,
        dataset_inputs: list[DatasetInput],
        model_inputs: list[LoggedModelInput] | None = None,
    ) -> None:
        self._dataset_inputs = dataset_inputs
        self._model_inputs = model_inputs or []
```

|속성|설명|
|---|---|
|dataset_inputs|이 Run이 입력으로 사용한 데이터셋에 대한 정보를 담고 있는 리스트<br>사용된 데이터셋의 이름, 소스, 스키마, 그리고 입력 유형(예: 학습 데이터) 등을 포함<br>세부적으로 들어가면 복잡함|
|model_inputs|이 Run이 입력으로 사용한 모델에 대한 정보를 담고 있는 리스트<br>모델 연결(Model Lineage)을 추적할 때 사용될 수 있음|


#### RunOutputs   

```python
# mlflow.entities.run_outputs
class RunOutputs(_MlflowObject):
    """RunOutputs object."""
    def __init__(self, model_outputs: list[LoggedModelOutput]) -> None:
        self._model_outputs = model_outputs
```

|속성|설명|
|---|---|
|_model_outputs|Run의 결과로 생성된 모델에 대한 정보를 담고 있는 리스트<br>mlflow.entities.LoggedModelOutput 인스턴스값이 들어간다.<br>이 Run에서 생성되어 로깅된 모델의 URI, 플레이버(Flavor), 서명(Signature) 등의 메타데이터를 포함|

### Run 다루기  

#### start_run  

```python
import mlflow

mlflow.start_run(
    run_id: str | None = None,
    experiment_id: str | None = None,
    run_name: str | None = None,
    nested: bool = False,
    parent_run_id: str | None = None,
    tags: dict[str, Any] | None = None,
    description: str | None = None,
    log_system_metrics: bool | None = None,
)
```

`mlflow.start_run`  

- 새로운 Run을 생성한다.  

|파라미터|자료형|설명|필수 여부|
|---|---|---|---|
|run_id|`str`|지정된 UUID를 가진 Run을 가져오고, 해당 Run의 매개변수와 메트릭을 기록한다.||
|experiment_id|`str`|현재 Run을 생성할 Experiment의 ID<br>run_id가 지정되지 않은 경우에만 적용된다.<br>experiment_id인수가 지정되지 않으면 다음 순서로 유효한 Experiment를 찾는다.||
|run_name|`str`|새 Run의 이름. run_id가 지정되지 않은 경우에만 적용되며, 이 경우 필수|`[필수]`|
|nested|`bool`|이 Run이 부모 Run에 중첩되는지 여부<br>기본값 False이며, True인 경우 중첩된 Run을 만든다.||
|parent_run_id|`str`|현재 Run이 지정된 UUID를 가진 Run 아래에 중첩시킨다.<br>부모 Run은 ACTIVE 상태여야 한다.||
|tags|`dict[str, Any]`|Run과 관련된 태그||
|description|`str`|Run에 대한 설명을 입력. 선택적으로 입력하면 됨.||
|log_system_metrics|`bool`|True : 시스템 메트릭(예: CPU/GPU 사용율)이 MLflow에 로깅된다.<br>None : 환경변수를 참고해 로깅 여부를 결정한다.<br>MLflow 2.8의 실험적 기능이며, 변경될 수 있다.<br>기본값은 None.||

#### end_run  

```python
import mlflow

# 보통 상태값 넘기지 않고 사용
mlflow.end_run()

# 상세 내용
mlflow.end_run(
    status: str = RunStatus.to_string(RunStatus.FINISHED)
    )
```

`mlflow.end_run`  

- 현재 Run을 종료한다. status 파라미터가 있지만, 쓰지 않아도 된다.  

|파라미터|자료형|설명|필수 여부|
|---|---|---|---|
|status|`str`|변경할 상태값. 지정하지 않아도 된다. 보통 지정하지 않는다.||

#### get_run  

```python
import mlflow

mlflow.get_run(run_id: str):
```

`mlflow.get_run`  

- 백엔드 저장소에서 run_id에 해당하는 Run을 가져온다.  
- 가져온 Run에는 RunInfo, RunData, RunInputs가 포함된다.  
- run_id가 없으면 Exception 이 발생한다.  

|파라미터|자료형|설명|필수 여부|
|---|---|---|---|
|run_id|`str`|Run에 대한 고유 식별자|필수|

#### active_run  

```python
import mlflow

mlflow.active_run()

# 함수 내부 작동
def active_run():
    active_run_stack = _active_run_stack.get()
    return active_run_stack[-1] if len(active_run_stack) > 0 else None
```

`mlflow.active_run`  

- 현재 스레드에서 활성화된 Run을 가져온다.  
- 해당 Run이 없는 경우 None을 반환한다.  


> (참고) 위 작동방식을 보니, **현재 스레드에서 활성화된 Run을 Stack에 쌓아두는** 것을 알 수 있다. 그러면 현재 스레드에 여러 Run이 있을 수도 있겠네!  

#### delete_run  

```python
import mlflow

mlflow.delete_run(run_id:str)

# 함수 내부 동작
def delete_run(run_id: str) -> None:
    MlflowClient().delete_run(run_id)
```

`mlflow.delete_run`  

- run_id에 해당하는 Run을 삭제한다.  
- MLflow 서버에서 삭제되는 것.  

|파라미터|자료형|설명|필수 여부|
|---|---|---|---|
|run_id|`str`|삭제할 Run의 고유 식별자|필수|

#### search_runs  

```python
import mlflow

mlflow.search_runs(
    experiment_ids: list[str] | None = None,
    filter_string: str = "",
    run_view_type: int = ViewType.ACTIVE_ONLY,
    max_results: int = SEARCH_MAX_RESULTS_PANDAS,
    order_by: list[str] | None = None,
    output_format: str = "pandas",
    search_all_experiments: bool = False,
    experiment_names: list[str] | None = None,
)
```

`mlflow.search_runs`  

- 조건에 맞는 Run을 검색함  

| 파라미터 | 자료형 | 설명 | 필수 여부 |
| --- | --- | --- | --- |
| experiment_ids | `list[str]` |검색할 Experiment의 ID 목록.<br>search_all_experiments=True이거나 experiment_names가 지정되지 않은 경우에 사용됨. |  |
| filter_string | `str` | 검색 조건을 지정하는 필터 문자열.<br>(예: "metrics.accuracy > 0.8 AND params.model = 'rf'") |  |
| run_view_type | `int` | 검색할 Run의 상태를 지정.<br>mlflow.entities.ViewType Enum 값 중 하나를 사용.<br>(기본값: ACTIVE_ONLY) |  |
| max_results | `int `| 반환할 검색 결과의 최대 개수. |  |
| order_by | `list[str]` | 결과를 정렬할 기준 목록.<br>Run의 속성 또는 메트릭을 사용하여 "속성 [ASC | DESC]" 형식으로 지정.<br>예: "metrics.rmse ASC" |  |
| output_format | `str` | 반환되는 결과의 형식.<br>"pandas" 또는 "list" 가능 |  |
| search_all_experiments | `bool` | 모든 Experiments에서 Run을 검색할지 여부를 지정.<br>True인 경우 experiment_ids나 experiment_names를 무시하고 모든 Experiments를 검색함. |  |
| experiment_names | `list[str]` | 검색할 Experiment의 이름 목록.<br>experiment_ids 대신 사용할 수 있음 |  |

#### get_parent_run  

```python
import mlflow

mlflow.get_parent_run(run_id: str)
```

`mlflow.get_parent_run`  

- run_id 의 부모 Run을 가져옴  

|파라미터|자료형|설명|필수 여부|
|---|---|---|---|
|run_id|`str`|대상 run_id|필수|

#### last_active_run  

```python
import mlflow

mlflow.last_active_run():
```

`mlflow.last_active_run`  

- 가장 최근에 활성화된 Run을 가져온다.  


## Reference  

[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.Run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.Run)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunInfo](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunInfo)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunStatus](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunStatus)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.LifecycleStage](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.LifecycleStage)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.entities.html?highlight=run#mlflow.entities.RunData)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=start_run#mlflow.start_run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=start_run#mlflow.start_run)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=end_run#mlflow.end_run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=end_run#mlflow.end_run)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=get_run#mlflow.get_run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=get_run#mlflow.get_run)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=delete%20run#mlflow.delete_run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=delete%20run#mlflow.delete_run)  
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=search_runs#mlflow.search_runs](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=search_runs#mlflow.search_runs)   
[https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=last_active_run#mlflow.last_active_run](https://mlflow.org/docs/latest/api_reference/python_api/mlflow.html?highlight=last_active_run#mlflow.last_active_run)  