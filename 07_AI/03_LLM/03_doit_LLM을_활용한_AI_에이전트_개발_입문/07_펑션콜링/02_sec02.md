
## GPT와 미국 주식 이야기하기  

### yfinance  

- 번외 md 파일 참고  

```python
uv add yfinance
```

### 회사 기본정보 가져오기 펑션  

```python
# _get_yf_stock_info.py
import yfinance as yf

def func(ticker: str):
    stock = yf.Ticker(ticker)
    info = stock.info
    return str(info)

tool_def = {
        "type": "function",
        "function": {
            "name": "get_yf_stock_info",
            "description": "해당 종목의 Yahoo Finance 정보를 반환합니다.",
            "parameters": {
                "type":"object",
                "properties":{
                    "ticker": {
                        "type":"string",
                        "description":"Yahoo Finance 정보를 반환할 종목의 티커를 입력하세요. (예:APPL)",
                    }
                },
                "required":["ticker"]
            }
        }
    }
```

```python
# gpt_function.py
from tools import _get_current_time, _get_yf_stock_info

tools = [
    _get_current_time.tool_def,
    _get_yf_stock_info.tool_def
]

def tool_mapping(messages:list[dict],
                 tool_name:str,
                 tool_call_id:str|int,
                 arguments:dict|None):
    if tool_name == "get_current_time":
        func_result = _get_current_time.func(timezone=arguments["timezone"])
    elif tool_name == "get_yf_stock_info":
        func_reuslt = _get_yf_stock_info.func(ticker=arguments["ticker"]), 
    
    messages.append(
        {
            "role" : "function",
            "tool_call_id" : tool_call_id,
            "name" : tool_name,
            "content" : func_reuslt, 
        }
    )
    
    return messages
```

- 스트림릿 실행  

```bash
uv run streamlit run main.py
```

![alt text](/assets/images/yf_stock_info_streamlit.png)

- 펑션콜링의 결과를 기반으로 잘 답변하는 것을 볼 수 있다.  

![alt text](/assets/images/stockinfo_what_time.png)  

- 또한 이어서 "애플의 본사 기준으로 지금 몇시야?" 에 대한 질문으로 본사 기준으로 펑션콜링을 한 번 더 하여 잘 답변하는 것을 볼 수 있다.  

### 데이터프레임 형태의 정보 표출  

- 과거의 주가 정보를 가져오는 history() 메서드  
- 주식 추천 정보를 가져오는 recommendations() 메서드  
- 이들은 판다스 데이터프레임 형태이므로 문자열로 표현이 적당하지 않음  
- 이 경우 `.to_markdown()` 메서드를 활용해 마크다운 형태로 표현하며, 이렇게 하면 GPT가 표 형식을 더 잘 이해할 수 있고, 스트림릿 스트림릿에서도 데이터가 테이블 형식으로 잘 표현됨  


- 마크다운이 아닌 경우 : 마크다운이 아닌 경우는 문자열이 아닌 객체임    

```bash
                            Open   High     Low  Close   Volume  Dividends  Stock Splits
Date                                                                                    
2026-01-26 00:00:00-05:00  12.35  12.35  12.160  12.21  2914700        0.0           0.0
2026-01-27 00:00:00-05:00  12.20  12.24  11.773  11.88  3323100        0.0           0.0
```


- 마크다운 형식  

```bash
| Date                      |   Open |   High |    Low |   Close |          Volume |   Dividends |   Stock Splits |
|:--------------------------|-------:|-------:|-------:|--------:|----------------:|------------:|---------------:|
| 2026-01-26 00:00:00-05:00 |  12.35 | 12.35  | 12.16  |   12.21 |      2.9147e+06 |           0 |              0 |
| 2026-01-27 00:00:00-05:00 |  12.2  | 12.24  | 11.773 |   11.88 |      3.3231e+06 |           0 |              0 |
| 2026-01-28 00:00:00-05:00 |  11.95 | 12.041 | 11.885 |   11.91 | 514875          |           0 |              0 |
```

그리고 이를 사용할 수 있게 펑션 추가  

```python
# _get_yf_stock_history.py
import yfinance as yf

def func(ticker:str, period:str):
    stock = yf.Ticker(ticker)
    hist = stock.history(period=period)
    return str(hist.to_markdown())

tool_def = {
        "type": "function",
        "function": {
            "name": "get_yf_stock_history",
            "description": "해당 종목의 Yahoo Finance 주가 정보를 반환합니다.",
            "parameters": {
                "type":"object",
                "properties":{
                    "ticker": {
                        "type":"string",
                        "description":"Yahoo Finance 주가 정보를 반환할 종목의 티커를 입력하세요. (예:APPL)",
                    },
                    "period": {
                        "type": "string",
                        "description":"주가 정보를 조회할 기간을 입력하세요. (예: 1d, 5d, 1mo, 3mo, 1y, 5y)"
                    }
                },
                "required":["ticker", "period"]
            }
        }
    }
```

```python
# _get_yf_stock_recommendations.py
import yfinance as yf

def func(ticker:str):
    stock = yf.Ticker(ticker)
    reco = stock.recommendations()
    return str(reco.to_markdown())

tool_def = {
        "type": "function",
        "function": {
            "name": "get_yf_stock_recommendations",
            "description": "해당 종목의 Yahoo Finance 추천 정보를 반환합니다.",
            "parameters": {
                "type":"object",
                "properties":{
                    "ticker": {
                        "type":"string",
                        "description":"Yahoo Finance 추처 정보를 반환할 종목의 티커를 입력하세요. (예:APPL)",
                    }
                },
                "required":["ticker"]
            }
        }
    }
```

```python
# gpt_function.py
from tools import _get_current_time, _get_yf_stock_info, _get_yf_stock_history, _get_yf_stock_recommendations

tools = [
    _get_current_time.tool_def,
    _get_yf_stock_info.tool_def,
    _get_yf_stock_history.tool_def,
    _get_yf_stock_recommendations.tool_def
]

def tool_mapping(messages:list[dict],
                 tool_name:str,
                 tool_call_id:str|int,
                 arguments:dict|None):
    if tool_name == "get_current_time":
        func_result = _get_current_time.func(timezone=arguments["timezone"])
    elif tool_name == "get_yf_stock_info":
        func_result = _get_yf_stock_info.func(ticker=arguments["ticker"])
    elif tool_name == "get_yf_stock_history":
        func_result = _get_yf_stock_history.func(ticker=arguments["ticker"], period=arguments["period"])
    elif tool_name == "get_yf_stock_recommendations":
        func_result = _get_yf_stock_recommendations.func(ticker=arguments["ticker"])
    
    messages.append(
        {
            "role" : "function",
            "tool_call_id" : tool_call_id,
            "name" : tool_name,
            "content" : func_result, 
        }
    )
    
    return messages
```

![alt text](/assets/images/yf_hist_reco.png)
